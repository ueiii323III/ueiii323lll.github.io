<!--profile.wxml-->
<navigation-bar title="æˆ‘çš„" back="{{true}}" color="white" background="#FF91A4" bindback="handleBack"></navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- ç”¨æˆ·å¤´åƒåŒºåŸŸ -->
    <view class="user-section">
      <view wx:if="{{userInfo}}" class="user-info">
        <image class="user-avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
        <text class="user-name">{{userInfo.nickName}}</text>
      </view>
      <view wx:else class="login-prompt">
        <button class="login-btn" bindtap="handleLogin">å¾®ä¿¡ç™»å½•</button>
        <button class="login-btn mock-btn" bindtap="handleMockLogin" style="margin-top: 10px; background: #2196F3;">
          æ¨¡æ‹Ÿç™»å½•(å¼€å‘æµ‹è¯•)
        </button>
      </view>
    </view>

    <!-- ç”¨æˆ·èµ„æ–™ç¼–è¾‘åŒºåŸŸ -->
    <view class="profile-section">
      <view class="section-header">
        <text class="section-title">åŸºç¡€å¥åº·ä¿¡æ¯</text>
        <view class="section-actions">
          <button wx:if="{{!isEditing && userProfile}}" class="refresh-btn-small" bindtap="refreshHealthData">åˆ·æ–°</button>
          <button wx:if="{{!isEditing && userProfile}}" class="edit-btn" bindtap="toggleEdit">ç¼–è¾‘</button>
        </view>
      </view>
      
      <!-- æŸ¥çœ‹æ¨¡å¼ -->
      <view wx:if="{{!isEditing && userProfile}}" class="profile-view">
        <view class="info-grid">
          <view class="info-item">
            <text class="info-label">èº«é«˜</text>
            <text class="info-value">{{userProfile.height}}cm</text>
          </view>
          <view class="info-item">
            <text class="info-label">ä½“é‡</text>
            <text class="info-value">{{userProfile.weight}}kg</text>
          </view>
          <view class="info-item">
            <text class="info-label">BMI</text>
            <text class="info-value">{{calculatedBMI > 0 ? calculatedBMI : '--'}} ({{calculatedBMI > 0 ? bmiCategoryText : '--'}})</text>
          </view>
          <view class="info-item">
            <text class="info-label">æ€§åˆ«</text>
            <text class="info-value">{{userProfile.gender === 'male' ? 'ç”·' : 'å¥³'}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">å¹´é¾„</text>
            <text class="info-value">{{userProfile.age}}å²</text>
          </view>
          <view class="info-item">
            <text class="info-label">æ´»åŠ¨é‡</text>
            <text class="info-value">{{activityLevelLabel}}</text>
          </view>
        </view>
        
        <view class="goal-section">
          <text class="info-label">å¥åº·ç›®æ ‡</text>
          <text class="goal-text">
            {{healthGoalLabel}}
            {{userProfile.otherGoal ? '(' + userProfile.otherGoal + ')' : ''}}
          </text>
        </view>
        
        <view class="target-weight-section">
          <text class="info-label">ç›®æ ‡ä½“é‡</text>
          <text class="target-weight-text">
            {{userProfile.targetWeight ? userProfile.targetWeight + 'kg' : '--'}}
          </text>
        </view>
      </view>
      
      <!-- ç¼–è¾‘æ¨¡å¼ -->
      <view wx:if="{{isEditing}}" class="profile-edit">
        <view class="form-group">
          <text class="form-label">èº«é«˜ (cm)</text>
          <input class="form-input" type="digit" placeholder="è¯·è¾“å…¥èº«é«˜" value="{{formData.height}}" bindinput="onHeightInput" />
        </view>
        
        <view class="form-group">
          <text class="form-label">ä½“é‡ (kg)</text>
          <input class="form-input" type="digit" placeholder="è¯·è¾“å…¥ä½“é‡" value="{{formData.weight}}" bindinput="onWeightInput" />
        </view>
        
        <view class="form-group">
          <text class="form-label">æ€§åˆ«</text>
          <radio-group class="radio-group" bindchange="onGenderChange">
            <label class="radio-item">
              <radio value="male" checked="{{formData.gender === 'male'}}" color="#4CAF50" />
              <text>ç”·</text>
            </label>
            <label class="radio-item">
              <radio value="female" checked="{{formData.gender === 'female'}}" color="#4CAF50" />
              <text>å¥³</text>
            </label>
          </radio-group>
        </view>
        
        <view class="form-group">
          <text class="form-label">å¹´é¾„</text>
          <input class="form-input" type="number" placeholder="è¯·è¾“å…¥å¹´é¾„" value="{{formData.age}}" bindinput="onAgeInput" />
        </view>
        
        <view class="form-group">
          <text class="form-label">æ—¥å¸¸æ´»åŠ¨é‡</text>
          <radio-group class="options-list" bindchange="onActivityLevelChange">
            <view wx:for="{{activityLevelOptions}}" wx:key="value" class="option-item">
              <label class="option-label">
                <radio value="{{item.value}}" checked="{{formData.activityLevel === item.value}}" color="#4CAF50" />
                <view class="option-content">
                  <text class="option-title">{{item.label}}</text>
                  <text class="option-desc">{{item.desc}}</text>
                </view>
              </label>
            </view>
          </radio-group>
        </view>
        
        <view class="form-group">
          <text class="form-label">å¥åº·ç›®æ ‡</text>
          <radio-group class="options-list" bindchange="onHealthGoalChange">
            <view wx:for="{{healthGoalOptions}}" wx:key="value" class="option-item">
              <label class="option-label">
                <radio value="{{item.value}}" checked="{{formData.healthGoal === item.value}}" color="#4CAF50" />
                <view class="option-content">
                  <text class="option-title">{{item.label}}</text>
                  <text class="option-desc">{{item.desc}}</text>
                </view>
              </label>
            </view>
          </radio-group>
        </view>
        
        <view class="form-group">
          <text class="form-label">ç›®æ ‡ä½“é‡ (kg)</text>
          <input class="form-input" type="digit" placeholder="è¯·è¾“å…¥ç›®æ ‡ä½“é‡" value="{{formData.targetWeight}}" bindinput="onTargetWeightInput" />
        </view>
        
        <view wx:if="{{formData.healthGoal === 'other'}}" class="form-group">
          <text class="form-label">å…¶ä»–ç›®æ ‡æè¿°</text>
          <input class="form-input" placeholder="è¯·æè¿°æ‚¨çš„å¥åº·ç›®æ ‡" value="{{formData.otherGoal}}" bindinput="onOtherGoalInput" />
        </view>
        
        <!-- è®¡ç®—ç»“æœé¢„è§ˆ -->
        <view wx:if="{{calculatedBMI > 0}}" class="calculation-result">
          <view class="result-item">
            <text class="result-label">è®¡ç®—ç»“æœ</text>
          </view>
          <view class="result-item">
            <text class="result-text">BMI: {{calculatedBMI}} ({{bmiCategoryText}})</text>
          </view>
          <view class="result-item">
            <text class="result-text">ç›®æ ‡ä½“é‡: {{formData.targetWeight || formData.weight}} kg</text>
          </view>
        </view>
        
        <view class="form-actions">
          <button class="cancel-btn" bindtap="cancelEdit">å–æ¶ˆ</button>
          <button class="save-btn" bindtap="saveProfile">ä¿å­˜</button>
        </view>
      </view>
      
      <!-- æœªå®Œå–„ä¿¡æ¯æç¤º -->
      <view wx:if="{{!userProfile && !isEditing}}" class="empty-profile">
        <view class="empty-icon">ğŸ“</view>
        <text class="empty-text">è¯·å®Œå–„æ‚¨çš„åŸºç¡€å¥åº·ä¿¡æ¯</text>
        <button class="complete-profile-btn" bindtap="toggleEdit">å®Œå–„ä¿¡æ¯</button>
      </view>
    </view>

    <!-- å¥åº·ç›®æ ‡åŒºåŸŸ -->
    <view wx:if="{{healthGoals}}" class="goals-section">
      <view class="section-title">å¥åº·ç›®æ ‡</view>
      <view class="goals-grid">
        <view class="goal-item">
          <text class="goal-icon">ğŸ’§</text>
          <text class="goal-value">{{healthGoals.dailyWaterIntake}}ml</text>
          <text class="goal-label">æ¯æ—¥é¥®æ°´</text>
        </view>
        <view class="goal-item">
          <text class="goal-icon">ğŸ”¥</text>
          <text class="goal-value">{{healthGoals.dailyCalorieMin}}-{{healthGoals.dailyCalorieMax}}kcal</text>
          <text class="goal-label">æ¯æ—¥çƒ­é‡</text>
        </view>
        <view class="goal-item">
          <text class="goal-icon">ğŸƒ</text>
          <text class="goal-value">{{healthGoals.dailyExerciseDuration}}min</text>
          <text class="goal-label">æ¯æ—¥è¿åŠ¨</text>
        </view>
      </view>
    </view>

    <!-- åŠŸèƒ½èœå• -->
    <view class="menu-section">
      <view class="menu-item" bindtap="navigateToData">
        <view class="menu-icon">ğŸ“Š</view>
        <text class="menu-text">æ•°æ®ä¸­å¿ƒ</text>
        <text class="menu-arrow">></text>
      </view>
      
      <view class="menu-item" bindtap="navigateToSettings">
        <view class="menu-icon">âš™ï¸</view>
        <text class="menu-text">æé†’è®¾ç½®</text>
        <text class="menu-arrow">></text>
      </view>
      
      <view class="menu-item" bindtap="exportData">
        <view class="menu-icon">ğŸ“¤</view>
        <text class="menu-text">æ•°æ®å¯¼å‡º</text>
        <text class="menu-arrow">></text>
      </view>
      
      <view class="menu-item" bindtap="clearData">
        <view class="menu-icon">ğŸ—‘ï¸</view>
        <text class="menu-text">æ¸…ç†æ•°æ®</text>
        <text class="menu-arrow">></text>
      </view>
      
      <view class="menu-item" bindtap="showAbout">
        <view class="menu-icon">â„¹ï¸</view>
        <text class="menu-text">å…³äºåº”ç”¨</text>
        <text class="menu-arrow">></text>
      </view>
    </view>
  </view>
</scroll-view>